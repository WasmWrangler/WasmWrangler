<Project>
  <Target Name="WasmCalculateFilesToPackage">
    <ItemGroup>
      <_WasmFilesToPackage Include="$(OutputPath)/**/*.dll" Exclude="$(WasmOutputPath)/**/*" />

      <_WasmFilesToPackage Update="*">
        <WasmOutputPath>$(WasmOutputPath)/managed/%(_WasmFilesToPackage.RecursiveDir)%(_WasmFilesToPackage.Filename)%(_WasmFilesToPackage.Extension)</WasmOutputPath>
      </_WasmFilesToPackage>
    </ItemGroup>
  </Target>
  
  <Target Name="WasmCallSDKPackager" DependsOnTargets="WasmEnsureSDKAvailable;WasmCalculateFilesToPackage"
    Inputs="@(_WasmFilesToPackage)"
    Outputs="@(_WasmFilesToPackage->'%(WasmOutputPath)')">

    <PropertyGroup Condition="'$(WasmPackagerFlags)' == ''">
      <!-- 
        NOTE: I've disabled the following flag for now as I'm not sure that
        it brings any benfit. If at some point the flag needs to be reactivated
        don't forget to add the double dash before "debug".
      -->
      <!-- <WasmPackagerFlags Condition="'$(Configuration)' == 'Debug'">debug</WasmPackagerFlags> -->
    </PropertyGroup>

    <PropertyGroup>
      <_WasmPackagerInputPath>&quot;$(OutputPath)$(AssemblyName).dll&quot;</_WasmPackagerInputPath>
      <_WasmPackagerArgs>--out=&quot;$(WasmOutputPath)&quot; $(WasmPackagerFlags) $(_WasmPackagerInputPath)</_WasmPackagerArgs>
    </PropertyGroup>

    <Message Importance="high" Text="WasmPackagerArgs = $(_WasmPackagerArgs)" />
    
    <Exec Command="$(WasmSDKPath)/packager.exe $(_WasmPackagerArgs)" />

    <ItemGroup>
      <_WasmBootstrapperJsFiles Include="
        $(WasmOutputPath)/mono-config.js;
        $(WasmOutputPath)/runtime.js;
        $(WasmOutputPath)/dotnet.js" />
    </ItemGroup>

    <!-- NOTE: Codition is required for incremental builds. -->
    <ItemGroup Condition="Exists('$(WasmOutputPath)/mono-config.js')">
      <_WasmBootstrapperJsFilesContents Include="$([System.IO.File]::ReadAllText(&quot;%(_WasmBootstrapperJsFiles.Identity)&quot;))" />
    </ItemGroup>

    <WriteLinesToFile File="$(WasmOutputPath)/wasm.bootstrapper.js" Lines="@(_WasmBootstrapperJsFilesContents)" Overwrite="true" />

    <Delete Files="@(_WasmBootstrapperJsFiles)" />
  </Target>
</Project>
