<Project>
  <Target Name="WasmBuild" AfterTargets="AfterBuild" DependsOnTargets="
    WasmInjectScripts;
    CalculateWasmOutputPath;
    WasmMoveTypeScriptOutput;
    WasmCompileScss;
    WasmCallSDKPackager;
    WasmCopyAssets" />

  <Target Name="WasmMoveTypeScriptOutput">    
    <Move 
      SourceFiles="@(GeneratedJavascript)"
      DestinationFiles="@(GeneratedJavascript->'$(OutputPath)/%(Identity)')" />
  </Target>
  
  <Target Name="WasmCalculateScssPaths">
    <ItemGroup>
      <ScssCompile Update="*">
        <RelativePath>%(ScssCompile.RecursiveDir)%(ScssCompile.Filename).css</RelativePath>
      </ScssCompile>
      <ScssCompile Update="*">
        <OutputPath>$(OutputPath)%(ScssCompile.RelativePath)</OutputPath>
      </ScssCompile>

      <ScssMapFiles Include="@(ScssCompile->'%(RelativePath).map')" />
      <ScssMapFiles Update="*">
        <RelativePath>%(ScssMapFiles.Identity)</RelativePath>
      </ScssMapFiles>
      <ScssMapFiles Update="*">
        <OutputPath>$(OutputPath)%(ScssMapFiles.RelativePath)</OutputPath>
      </ScssMapFiles>
    </ItemGroup>
  </Target>
  
  <Target Name="WasmCompileScss" Condition="@(ScssCompile->Count()) &gt; 0" DependsOnTargets="WasmCalculateScssPaths"
    Inputs="@(ScssCompile)"
    Outputs="@(ScssCompile->'%(OutputPath)')">
    <Exec Command="$(WasmWranglerBuildCommand) CompileScss &quot;%(ScssCompile.FullPath)&quot; &quot;%(ScssCompile.OutputPath)&quot;" />
  </Target>
  
  <Target Name="WasmCopyAssets">
    <ItemGroup>
      <WasmAssets Include="@(None)" Condition="'%(None.CopyToOutputDirectory)' != '' And '%(None.CopyToOutputDirectory)' != 'Never'">
        <Source>%(None.Identity)</Source>
        
        <Destination Condition="'%(None.Link)' == ''">$(WasmOutputPath)/%(None.RecursiveDir)%(None.FileName)%(None.Extension)</Destination>
        <Destination Condition="'%(None.Link)' != ''">$(WasmOutputPath)/%(None.Link)</Destination>

        <SkipUnchangedFiles Condition="'%(None.CopyToOutputDirectory)' == 'Always'">false</SkipUnchangedFiles>
        <SkipUnchangedFiles Condition="'%(None.CopyToOutputDirectory)' == 'PreserveNewest'">true</SkipUnchangedFiles>
      </WasmAssets>

      <!-- JavaScript files -->
      <WasmAssets Condition="@(GeneratedJavascript->Count()) &gt; 0" Include="@(GeneratedJavascript)">
        <Source>$(OutputPath)/%(GeneratedJavascript.Identity)</Source>
        <Destination>$(WasmOutputPath)/%(GeneratedJavascript.Identity)</Destination>
        <SkipUnchangedFiles>true</SkipUnchangedFiles>
      </WasmAssets>
      
      <!-- SCSS files -->
      <WasmAssets Condition="@(ScssCompile->Count()) &gt; 0" Include="@(ScssCompile)">
        <Source>%(ScssCompile.OutputPath)</Source>
        <Destination>$(WasmOutputPath)/%(ScssCompile.RelativePath)</Destination>
        <SkipUnchangedFiles>true</SkipUnchangedFiles>
      </WasmAssets>

      <!-- SCSS map files -->
      <WasmAssets Condition="@(ScssCompile->Count()) &gt; 0" Include="@(ScssMapFiles)">
        <Source>%(ScssMapFiles.OutputPath)</Source>
        <Destination>$(WasmOutputPath)/%(ScssMapFiles.RelativePath)</Destination>
        <SkipUnchangedFiles>true</SkipUnchangedFiles>
      </WasmAssets>
    </ItemGroup>
    
    <Copy
        SourceFiles="%(WasmAssets.Source)"
        DestinationFiles="%(WasmAssets.Destination)"
        SkipUnchangedFiles="%(WasmAssets.SkipUnchangedFiles)" />
  </Target>
</Project>
